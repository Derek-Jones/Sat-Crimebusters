"use strict";angular.module("Utils",[]).constant("setupD3",function(t){function e(t,e){return t||e}var n={};switch(n.width=e(t.width,1e3),n.height=e(t.height,500),n.margin=e(t.margin,0),n.marginLeft=e(t.marginLeft,n.margin),n.marginRight=e(t.marginRight,n.margin),n.marginTop=e(t.marginTop,n.margin),n.marginBottom=e(t.marginBottom,n.margin),n.bounds=t.bounds,t.svg.attr("width",n.width).attr("height",n.height),t.scale){default:n.xMap=d3.scale.linear().domain(n.bounds.x).range([0+n.marginLeft,n.width-n.marginRight]),n.yMap=d3.scale.linear().domain([n.bounds.y[0]+.5,n.bounds.y[1]+.5]).range([-n.height+n.marginBottom,0-n.marginTop])}return n}).constant("clone",function(t){var e={};for(var n in t)e[n]=t[n];return e}).filter("stripNans",function(){return function(t){return t.filter(function(t){return!isNaN(t.coords[0])})}}),angular.module("ScatterPlot",["Utils"]).directive("ocScatterPlot",["$filter","setupD3",function(t,e){function n(n,i){var r=d3.select(i[0]).select("svg"),s=e({width:n.width(),height:n.height(),bounds:n.bounds(),svg:r}),o=t("stripNans")(n.points()),a=r.selectAll("circle").data(o);a.enter().append("circle").attr("cx",function(t){return s.xMap(t[0])}).attr("cy",function(t){return-s.yMap(t[1])}).attr("r",2)}return{restrict:"E",template:"<svg></svg>",link:n,scope:{points:"&ocPoints",width:"&ocWidth",height:"&ocHeight",bounds:"&ocBounds"}}}]),angular.module("Transmissions",["Utils"]).constant("Transmission",function(){function t(t){return n[t]=n[t]||"#"+(16777215*Math.random()<<0).toString(16)}function e(e){for(this.mmsi=e[0],this.date=e[1],this.time=e[2];this.time.length<6;)this.time="0"+this.time;this.coords=[parseFloat(e[3]),parseFloat(e[4])],this.timestamp=parseFloat(this.date+this.time),this.color=t(this.mmsi)}var n=[];return e.prototype.longitude=function(){return this.coords[0]},e.prototype.latitude=function(){return this.coords[1]},e}()),angular.module("Maps",["Transmissions"]).controller("MapsController",["$scope","$timeout","$rootScope","TransmissionsService",function(t,e,n,i){function r(){t.ready=!0,i.removeListener(r)}t.width=1e3,t.height=500,t.center=new google.maps.LatLng(38.56293181498852,16.47674560546875);var s=[{featureType:"water",elementType:"geometry",stylers:[{color:"#193341"}]},{featureType:"landscape",elementType:"geometry",stylers:[{color:"#2c5a71"}]},{featureType:"road",elementType:"geometry",stylers:[{color:"#29768a"},{lightness:-37}]},{featureType:"poi",elementType:"geometry",stylers:[{color:"#406d80"}]},{featureType:"transit",elementType:"geometry",stylers:[{color:"#406d80"}]},{elementType:"labels.text.stroke",stylers:[{visibility:"on"},{color:"#3e606f"},{weight:2},{gamma:.84}]},{elementType:"labels.text.fill",stylers:[{visibility:"off"},{color:"#ffffff"}]},{featureType:"administrative",elementType:"geometry",stylers:[{weight:.6},{color:"#1a3541"}]},{elementType:"labels.icon",stylers:[{visibility:"off"}]},{featureType:"poi.park",elementType:"geometry",stylers:[{color:"#2c5a71"}]}],o={center:t.center,zoom:5,panControl:!1,zoomControl:!1,overviewMapControl:!1,streetViewControl:!1,scaleControl:!1,mapTypeControl:!1,mapTypeId:google.maps.MapTypeId.ROADMAP,styles:s};t.map=new google.maps.Map(document.getElementById("map-canvas"),o),google.maps.event.addListenerOnce(t.map,"bounds_changed",function(){var e=t.map.getBounds(),n=e.getNorthEast(),i=e.getSouthWest();t.$apply(function(t){t.bounds={x:[i.lng(),n.lng()],y:[i.lat(),n.lat()]}})}),t.bounds={x:[-5.49591064453125,38.44940185546875],y:[29.475171256180307,46.63222897271767]},t.ready=!1,i.addListener(r)}]),angular.module("Transmissions").service("TransmissionsService",["$http","Transmission","clone",function(t,e,n){function i(){var t=a.length-1;do a[t].call();while(t--)}function r(t){for(var n=t.trim(),i=n.split("\n"),r=(i[0].split(","),[]),s=1;s<i.length;s++){var o=i[s].split(",");r.push(new e(o))}return r}function s(t){function e(t){return Object.keys(t).sort(function(t,e){return parseFloat(e)-parseFloat(t)})}function i(t){return new Date(t.slice(0,4),t.slice(4,6),t.slice(6,8),t.slice(8,10),t.slice(10,12),t.slice(12,14))}var r,s,o=1e4,a={},c=t.sort(function(t,e){return t.timestamp-e.timestamp}).map(function(t){return a[t.mmsi]=a[t.mmsi]||{obj:t,points:[]},a[t.mmsi].points.push(t.coords),t.bucket=(Math.floor(t.timestamp/o)*o).toString(),t}),l={},r=c.length-1;do{var u=c[r].bucket;l[u]=l[u]||{},l[u][c[r].mmsi]=c[r]}while(r--);var m=[],p=e(l),d={},h=0,g={},r=p.length-1;do{var f=n(d),v=[];for(var y in l[p[r]]){var T=l[p[r]][y];g[T.mmsi]=g[T.mmsi]||function(){return h+=1}(),f[T.mmsi]=T,v.push(T.mmsi)}for(var b=Object.keys(f),w=[],s=0;s<b.length;s++)w.push(f[b[s]]);m.push({timestamp:i(p[r]),transmissions:w.sort(function(t,e){return g[t.mmsi]-g[e.mmsi]}),active:v}),d=f}while(r--);var w=[];for(var u in a)w.push(a[u]);return{compressed:w,buckets:m}}var o=this;o.transmissions=[],o.timeSeries=[],o.compressedSeries=[];var a=[];return o.addListener=function(t){-1===a.indexOf(t)&&a.push(t)},o.removeListener=function(t){var e=a.indexOf(t);-1!==e&&a.splice(e)},t({method:"GET",url:"/transmissions"}).success(function(t){o.transmissions=r(t);var e=s(o.transmissions);o.timeSeries=e.buckets,o.compressedSeries=e.compressed,i()}).error(function(t){alert(t)}),this}]).filter("grabCoordinates",function(){return function(t){return t.map(function(t){return t.coords})}}),angular.module("Visualizations",["Transmissions","Utils"]),angular.module("App",["Transmissions","ScatterPlot","Visualizations","Maps","ngRoute"]).config(["$routeProvider",function(t){t.when("/track",{templateUrl:"views/track.html"}).when("/routes",{templateUrl:"views/routes.html"}).otherwise({redirectTo:"/track"})}]).directive("bsNavLink",["$location",function(t){return{restrict:"E",replace:!0,scope:{},template:'<li><a href="#{{href}}">{{text}}</a></li>',link:function(e,n,i){var r=i.bsHref;e.href=r,e.text=i.bsText,e.location=t,e.$watch("location.path()",function(t){r==t?n.addClass("active"):n.removeClass("active")})}}}]),angular.module("Visualizations").directive("routeTrace",["TransmissionsService","setupD3",function(t,e){function n(t,n){var r=d3.select(n[0]).select("svg"),s=e({bounds:t.bounds(),svg:r}),o=d3.svg.line().x(function(t){return s.xMap(t[0])}).y(function(t){return-s.yMap(t[1])});r.selectAll(".vessel-route").data(i).enter().append("g").attr("class","vessel-route").append("path").attr("d",function(t){return o(t.points)}).style("stroke",function(t){return t.obj.color}).style("fill","none").style("opacity",.5)}var i=t.compressedSeries;return t.addListener(function(){i=t.compressedSeries}),{restrict:"E",template:"<svg></svg>",link:n,scope:{bounds:"&ocBounds"}}}]),angular.module("Visualizations").directive("vesselTracking",["$filter","$timeout","TransmissionsService","setupD3",function(t,e,n,i){function r(){if(u=n.timeSeries,0!==u.length)for(var e=0;e<u.length;e++)u[e].transmissions=t("stripNans")(u[e].transmissions)}function s(){function t(t){return l.xMap(t.coords[0])}function n(t){return-l.yMap(t.coords[1])}function i(t){return t.color}function r(t){return-1!==m.active.indexOf(t.mmsi)?1:.3}function o(e){e.attr("cx",t).attr("cy",n).attr("r",2).style("fill",i).style("opacity",r)}var m=(u[a-1]||{transmissions:[]},u[a]);if("undefined"==typeof m)return void e(s,800);var p=c.selectAll("circle").data(m.transmissions.slice(0,800));c.select("text.timestamp").text(m.timestamp.toString()+" ["+a+"/"+u.length+"]"),p.exit().remove(),o(p.transition()),o(p.enter().append("circle"));d3.svg.line().x(function(t){return l.xMap(t.coords[0])}).y(function(t){return-l.yMap(t.coords[1])});a=(a+1)%u.length,e(s,800)}function o(t,e){function n(){l=i({width:t.width(),height:t.height(),bounds:t.bounds(),svg:c})}a=0,c=d3.select(e[0]).select("svg"),t.$on("$destroy",function(){c=void 0,clearTimeout(s)}),t.$watch(n),n(),s()}var a,c,l,u=n.timeSeries;return r(),n.addListener(r),{restrict:"E",templateUrl:"visualizations/vessel-tracking.html",link:o,scope:{width:"&ocWidth",height:"&ocHeight",bounds:"&ocBounds"}}}]),angular.module("App").run(["$templateCache",function(t){t.put("views/routes.html",'<route-trace oc-width="width" oc-height="height" oc-bounds="bounds"></route-trace>\n'),t.put("views/track.html",'<vessel-tracking oc-width="width" oc-height="height" oc-bounds="bounds"></vessel-tracking>\n'),t.put("visualizations/vessel-tracking.html",'<svg>\n  <g transform="translate(10, 25)">\n    <text class="timestamp"></text>\n  </g>\n</svg>\n')}]);