"use strict";angular.module("Utils",[]).constant("setupD3",function(t){function e(t,e){return t||e}var n={};switch(n.width=e(t.width,1e3),n.height=e(t.height,500),n.margin=e(t.margin,0),n.marginLeft=e(t.marginLeft,n.margin),n.marginRight=e(t.marginRight,n.margin),n.marginTop=e(t.marginTop,n.margin),n.marginBottom=e(t.marginBottom,n.margin),n.bounds=t.bounds,t.svg.attr("width",n.width).attr("height",n.height),t.scale){default:n.xMap=d3.scale.linear().domain(n.bounds.x).range([0+n.marginLeft,n.width-n.marginRight]),n.yMap=d3.scale.linear().domain([n.bounds.y[0]+.5,n.bounds.y[1]+.5]).range([n.height-n.marginBottom,0+n.marginTop])}return n}).constant("clone",function(t){var e={};for(var n in t)e[n]=t[n];return e}).filter("stripNans",function(){return function(t){return t.filter(function(t){return!isNaN(t.coords[0])})}}),angular.module("ScatterPlot",["Utils"]).directive("ocScatterPlot",["$filter","setupD3",function(t,e){function n(n,s){var i=d3.select(s[0]).select("svg"),r=e({width:n.width(),height:n.height(),bounds:n.bounds(),svg:i}),o=t("stripNans")(n.points()),a=i.selectAll("circle").data(o);a.enter().append("circle").attr("cx",function(t){return r.xMap(t[0])}).attr("cy",function(t){return-r.yMap(t[1])}).attr("r",2)}return{restrict:"E",template:"<svg></svg>",link:n,scope:{points:"&ocPoints",width:"&ocWidth",height:"&ocHeight",bounds:"&ocBounds"}}}]),angular.module("Transmissions",["Utils"]).constant("Transmission",function(){function t(t){return n[t]=n[t]||"#"+(16777215*Math.random()<<0).toString(16)}function e(e){this.mmsi=e[0],this.date=e[1],this.time=e[2],this.coords=[parseFloat(e[3]),parseFloat(e[4])],this.timestamp=parseFloat(this.date+this.time),this.color=t(this.mmsi),this.mdist=e[5]}var n=[];return e.prototype.longitude=function(){return this.coords[0]},e.prototype.latitude=function(){return this.coords[1]},e}()),angular.module("Maps",["Transmissions"]).controller("MapsController",["$scope","$timeout","$rootScope","TransmissionsService",function(t,e,n,s){function i(){t.ready=!0,s.removeListener(i)}t.width=1e3,t.height=500,t.center=new google.maps.LatLng(38.56293181498852,16.47674560546875);var r=[{featureType:"water",elementType:"geometry",stylers:[{color:"#193341"}]},{featureType:"landscape",elementType:"geometry",stylers:[{color:"#2c5a71"}]},{featureType:"road",elementType:"geometry",stylers:[{color:"#29768a"},{lightness:-37}]},{featureType:"poi",elementType:"geometry",stylers:[{color:"#406d80"}]},{featureType:"transit",elementType:"geometry",stylers:[{color:"#406d80"}]},{elementType:"labels.text.stroke",stylers:[{visibility:"on"},{color:"#3e606f"},{weight:2},{gamma:.84}]},{elementType:"labels.text.fill",stylers:[{visibility:"off"},{color:"#ffffff"}]},{featureType:"administrative",elementType:"geometry",stylers:[{weight:.6},{color:"#1a3541"}]},{elementType:"labels.icon",stylers:[{visibility:"off"}]},{featureType:"poi.park",elementType:"geometry",stylers:[{color:"#2c5a71"}]}],o={center:t.center,zoom:5,panControl:!1,zoomControl:!1,overviewMapControl:!1,streetViewControl:!1,scaleControl:!1,mapTypeControl:!1,mapTypeId:google.maps.MapTypeId.ROADMAP,styles:r};t.map=new google.maps.Map(document.getElementById("map-canvas"),o),google.maps.event.addListenerOnce(t.map,"bounds_changed",function(){var e=t.map.getBounds(),n=e.getNorthEast(),s=e.getSouthWest();t.$apply(function(t){t.bounds={x:[s.lng(),n.lng()],y:[s.lat(),n.lat()]}})}),t.bounds={x:[-5.49591064453125,38.44940185546875],y:[29.475171256180307,46.63222897271767]},t.ready=!1,s.addListener(i)}]),angular.module("Transmissions").service("TransmissionsService",["$http","Transmission","clone",function(t,e,n){function s(){var t=a.length-1;do a[t].call();while(t--)}function i(t){for(var n=t.trim(),s=n.split("\n"),i=(s[0].split(","),[]),r=1;r<s.length;r++){var o=s[r].split(",");i.push(new e(o))}return i}function r(t){function e(t){return Object.keys(t).sort(function(t,e){return parseFloat(e)-parseFloat(t)})}function s(t){return new Date(t.slice(0,4),t.slice(4,6),t.slice(6,8),t.slice(8,10),t.slice(10,12),t.slice(12,14))}var i,r,o=2e4,a={},c=t.sort(function(t,e){return t.timestamp-e.timestamp}).map(function(t){return a[t.mmsi]=a[t.mmsi]||{obj:t,points:[]},a[t.mmsi].points.push(t.coords),t.bucket=(Math.floor(t.timestamp/o)*o).toString(),t}),l={},i=c.length-1;do{var u=c[i].bucket;l[u]=l[u]||{},l[u][c[i].mmsi]=c[i]}while(i--);var m=[],d=e(l),p={},h=0,g={},i=d.length-1;do{var f=n(p),v=[];for(var y in l[d[i]]){var b=l[d[i]][y];g[b.mmsi]=g[b.mmsi]||function(){return h+=1}(),f[b.mmsi]=b,v.push(b.mmsi)}for(var w=Object.keys(f),T=[],r=0;r<w.length;r++)T.push(f[w[r]]);m.push({timestamp:s(d[i]),transmissions:T.sort(function(t,e){return g[t.mmsi]-g[e.mmsi]}),active:v}),p=f}while(i--);var T=[];for(var u in a)T.push(a[u]);return{compressed:T,buckets:m}}var o=this;o.transmissions=[],o.timeSeries=[],o.compressedSeries=[];var a=[];return o.addListener=function(t){-1===a.indexOf(t)&&a.push(t)},o.removeListener=function(t){var e=a.indexOf(t);-1!==e&&a.splice(e)},t({method:"GET",url:"/transmissions"}).success(function(t){o.transmissions=i(t);var e=r(o.transmissions);o.timeSeries=e.buckets,o.compressedSeries=e.compressed,s()}).error(function(t){alert(t)}),this}]).filter("grabCoordinates",function(){return function(t){return t.map(function(t){return t.coords})}}),angular.module("Visualizations",["Transmissions","Utils"]),angular.module("App",["Transmissions","ScatterPlot","Visualizations","Maps","ngRoute"]).config(["$routeProvider",function(t){t.when("/track",{templateUrl:"views/track.html"}).when("/routes",{templateUrl:"views/routes.html"}).otherwise({redirectTo:"/track"})}]).directive("bsNavLink",["$location",function(t){return{restrict:"E",replace:!0,scope:{},template:'<li><a href="#{{href}}">{{text}}</a></li>',link:function(e,n,s){var i=s.bsHref;e.href=i,e.text=s.bsText,e.location=t,e.$watch("location.path()",function(t){i==t?n.addClass("active"):n.removeClass("active")})}}}]),angular.module("Visualizations").directive("routeTrace",["TransmissionsService","setupD3",function(t,e){function n(t,n){var i=d3.select(n[0]).select("svg"),r=e({bounds:t.bounds(),svg:i}),o=d3.svg.line().x(function(t){return r.xMap(t[0])}).y(function(t){return r.yMap(t[1])});i.selectAll(".vessel-route").data(s).enter().append("g").attr("class","vessel-route").append("path").attr("d",function(t){return o(t.points)}).style("stroke",function(t){return t.obj.color}).style("fill","none").style("opacity",.5)}var s=t.compressedSeries;return t.addListener(function(){s=t.compressedSeries}),{restrict:"E",template:"<svg></svg>",link:n,scope:{bounds:"&ocBounds"}}}]),angular.module("Visualizations").directive("transmissionsFrequency",["TransmissionsService","setupD3",function(t,e){function n(t,n){i=d3.select(n[0]).select("svg"),s=e({width:t.width(),height:t.height(),bounds:t.bounds(),svg:i})}var s,i,r=t.transmissions;return t.addListener(function(){r=t.transmissions}),{restrict:"E",templateUrl:"visualizations/transmissions-frequency.html",link:n,scope:{width:"&ocWidth",height:"&ocHeight",bounds:"&ocBounds"}}}]),angular.module("Visualizations").directive("vesselTracking",["$filter","$timeout","TransmissionsService","setupD3",function(t,e,n,s){function i(){if(u=n.timeSeries,0!==u.length)for(var e=0;e<u.length;e++)u[e].transmissions=t("stripNans")(u[e].transmissions)}function r(){function t(t){return l.xMap(t.coords[0])}function n(t){return l.yMap(t.coords[1])}function s(t){return t.color}function i(t){return-1!==d.active.indexOf(t.mmsi)&&t.mdist>.001?2+2*t.mdist:2}function o(t){return-1!==d.active.indexOf(t.mmsi)?1:.3}function m(e){e.attr("cx",t).attr("cy",n).attr("r",i).style("fill",s).style("opacity",o)}var d=(u[a-1]||{transmissions:[]},u[a]);if("undefined"==typeof d)return void e(r,800);var p=c.selectAll("circle").data(d.transmissions.slice(0,800));c.select("text.timestamp").text(d.timestamp.toString()+" ["+a+"/"+u.length+"]"),p.exit().remove(),m(p.transition()),m(p.enter().append("circle"));d3.svg.line().x(function(t){return l.xMap(t.coords[0])}).y(function(t){return-l.yMap(t.coords[1])});a=(a+1)%u.length,e(r,800)}function o(t,e){function n(){l=s({width:t.width(),height:t.height(),bounds:t.bounds(),svg:c})}a=0,c=d3.select(e[0]).select("svg"),t.$on("$destroy",function(){c=void 0,clearTimeout(r)}),t.$watch(n),n(),r()}var a,c,l,u=n.timeSeries;return i(),n.addListener(i),{restrict:"E",templateUrl:"visualizations/vessel-tracking.html",link:o,scope:{width:"&ocWidth",height:"&ocHeight",bounds:"&ocBounds"}}}]),angular.module("App").run(["$templateCache",function(t){t.put("views/graphs.html",'<transmissions-frequency oc-bounds="bounds" oc-width="width" oc-height="height"></transmissions-frequency>\n'),t.put("views/routes.html",'<route-trace oc-width="width" oc-height="height" oc-bounds="bounds"></route-trace>\n'),t.put("views/track.html",'<vessel-tracking oc-width="width" oc-height="height" oc-bounds="bounds"></vessel-tracking>\n'),t.put("visualizations/transmissions-frequency.html","<svg></svg>\n"),t.put("visualizations/vessel-tracking.html",'<svg>\n  <g transform="translate(10, 25)">\n    <text class="timestamp"></text>\n  </g>\n</svg>\n')}]);